{"version":3,"file":"zaplib_nodejs_polyfill.js","mappings":"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","sources":["webpack://zaplib/webpack/universalModuleDefinition","webpack://zaplib/./vendor/web-worker/node.js","webpack://zaplib/./vendor/web-worker|lazy|groupOptions: {}|namespace object","webpack://zaplib/./vendor/web-worker|sync","webpack://zaplib/external node-commonjs \"url\"","webpack://zaplib/external node-commonjs \"vm\"","webpack://zaplib/external node-commonjs \"worker_threads\"","webpack://zaplib/webpack/bootstrap","webpack://zaplib/webpack/runtime/compat get default export","webpack://zaplib/webpack/runtime/define property getters","webpack://zaplib/webpack/runtime/hasOwnProperty shorthand","webpack://zaplib/webpack/runtime/make namespace object","webpack://zaplib/./zaplib_nodejs_polyfill.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"zaplib\"] = factory();\n\telse\n\t\troot[\"zaplib\"] = factory();\n})(global, function() {\nreturn ","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconst URL = require(\"url\");\n\nconst VM = require(\"vm\");\n\nconst threads = require(\"worker_threads\");\n\nconst WORKER = Symbol.for(\"worker\");\nconst EVENTS = Symbol.for(\"events\");\n\nclass EventTarget {\n  constructor() {\n    Object.defineProperty(this, EVENTS, {\n      value: new Map(),\n    });\n  }\n\n  dispatchEvent(event) {\n    event.target = event.currentTarget = this;\n\n    if (this[\"on\" + event.type]) {\n      try {\n        this[\"on\" + event.type](event);\n      } catch (err) {\n        console.error(err);\n      }\n    }\n\n    const list = this[EVENTS].get(event.type);\n    if (list == null) return;\n    list.forEach((handler) => {\n      try {\n        handler.call(this, event);\n      } catch (err) {\n        console.error(err);\n      }\n    });\n  }\n\n  addEventListener(type, fn) {\n    let events = this[EVENTS].get(type);\n    if (!events) this[EVENTS].set(type, (events = []));\n    events.push(fn);\n  }\n\n  removeEventListener(type, fn) {\n    let events = this[EVENTS].get(type);\n\n    if (events) {\n      const index = events.indexOf(fn);\n      if (index !== -1) events.splice(index, 1);\n    }\n  }\n}\n\nfunction Event(type, target) {\n  this.type = type;\n  this.timeStamp = Date.now();\n  this.target = this.currentTarget = this.data = null;\n} // this module is used self-referentially on both sides of the\n// thread boundary, but behaves differently in each context.\n\nmodule.exports = threads.isMainThread ? mainThread() : workerThread();\nconst baseUrl = URL.pathToFileURL(process.cwd() + \"/\");\n\nfunction mainThread() {\n  /**\n   * A web-compatible Worker implementation atop Node's worker_threads.\n   *  - uses DOM-style events (Event.data, Event.type, etc)\n   *  - supports event handler properties (worker.onmessage)\n   *  - Worker() constructor accepts a module URL\n   *  - accepts the {type:'module'} option\n   *  - emulates WorkerGlobalScope within the worker\n   * @param {string} url  The URL or module specifier to load\n   * @param {object} [options]  Worker construction options\n   * @param {string} [options.name]  Available as `self.name` within the Worker\n   * @param {string} [options.type=\"classic\"]  Pass \"module\" to create a Module Worker.\n   */\n  class Worker extends EventTarget {\n    constructor(url, options) {\n      super();\n      const { name, type } = options || {};\n      url += \"\";\n      let mod;\n\n      if (/^data:/.test(url)) {\n        mod = url;\n      } else {\n        mod = URL.fileURLToPath(new URL.URL(url, baseUrl));\n      }\n\n      const worker = new threads.Worker(__filename, {\n        workerData: {\n          mod,\n          name,\n          type,\n        },\n      });\n      Object.defineProperty(this, WORKER, {\n        value: worker,\n      });\n      worker.on(\"message\", (data) => {\n        const event = new Event(\"message\");\n        event.data = data;\n        this.dispatchEvent(event);\n      });\n      worker.on(\"error\", (error) => {\n        error.type = \"error\";\n        this.dispatchEvent(error);\n      });\n      worker.on(\"exit\", () => {\n        this.dispatchEvent(new Event(\"close\"));\n      });\n    }\n\n    postMessage(data, transferList) {\n      this[WORKER].postMessage(data, transferList);\n    }\n\n    terminate() {\n      this[WORKER].terminate();\n    }\n  }\n\n  Worker.prototype.onmessage =\n    Worker.prototype.onerror =\n    Worker.prototype.onclose =\n      null;\n  return Worker;\n}\n\nfunction workerThread() {\n  let { mod, name, type } = threads.workerData; // turn global into a mock WorkerGlobalScope\n\n  const self = (global.self = global); // enqueue messages to dispatch after modules are loaded\n\n  let q = [];\n\n  function flush() {\n    const buffered = q;\n    q = null;\n    buffered.forEach((event) => {\n      self.dispatchEvent(event);\n    });\n  }\n\n  threads.parentPort.on(\"message\", (data) => {\n    const event = new Event(\"message\");\n    event.data = data;\n    if (q == null) self.dispatchEvent(event);\n    else q.push(event);\n  });\n  threads.parentPort.on(\"error\", (err) => {\n    err.type = \"Error\";\n    self.dispatchEvent(err);\n  });\n\n  class WorkerGlobalScope extends EventTarget {\n    postMessage(data, transferList) {\n      threads.parentPort.postMessage(data, transferList);\n    } // Emulates https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope/close\n\n    close() {\n      process.exit();\n    }\n  }\n\n  let proto = Object.getPrototypeOf(global);\n  delete proto.constructor;\n  Object.defineProperties(WorkerGlobalScope.prototype, proto);\n  proto = Object.setPrototypeOf(global, new WorkerGlobalScope());\n  [\n    \"postMessage\",\n    \"addEventListener\",\n    \"removeEventListener\",\n    \"dispatchEvent\",\n  ].forEach((fn) => {\n    proto[fn] = proto[fn].bind(global);\n  });\n  global.name = name;\n  const isDataUrl = /^data:/.test(mod);\n\n  if (type === \"module\") {\n    import(mod)\n      .catch((err) => {\n        if (isDataUrl && err.message === \"Not supported\") {\n          console.warn(\n            \"Worker(): Importing data: URLs requires Node 12.10+. Falling back to classic worker.\"\n          );\n          return evaluateDataUrl(mod, name);\n        }\n\n        console.error(err);\n      })\n      .then(flush);\n  } else {\n    try {\n      if (/^data:/.test(mod)) {\n        evaluateDataUrl(mod, name);\n      } else {\n        require(mod);\n      }\n    } catch (err) {\n      console.error(err);\n    }\n\n    Promise.resolve().then(flush);\n  }\n}\n\nfunction evaluateDataUrl(url, name) {\n  const { data } = parseDataUrl(url);\n  return VM.runInThisContext(data, {\n    filename: \"worker.<\" + (name || \"data:\") + \">\",\n  });\n}\n\nfunction parseDataUrl(url) {\n  let [m, type, encoding, data] =\n    url.match(/^data: *([^;,]*)(?: *; *([^,]*))? *,(.*)$/) || [];\n  if (!m) throw Error(\"Invalid Data URL.\");\n  data = decodeURIComponent(data);\n  if (encoding)\n    switch (encoding.toLowerCase()) {\n      case \"base64\":\n        data = Buffer.from(data, \"base64\").toString();\n        break;\n\n      default:\n        throw Error('Unknown Data URL encoding \"' + encoding + '\"');\n    }\n  return {\n    type,\n    data,\n  };\n}\n","function webpackEmptyAsyncContext(req) {\n\t// Here Promise.resolve().then() is used instead of new Promise() to prevent\n\t// uncaught exception popping up in devtools\n\treturn Promise.resolve().then(() => {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t});\n}\nwebpackEmptyAsyncContext.keys = () => ([]);\nwebpackEmptyAsyncContext.resolve = webpackEmptyAsyncContext;\nwebpackEmptyAsyncContext.id = 248;\nmodule.exports = webpackEmptyAsyncContext;","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = () => ([]);\nwebpackEmptyContext.resolve = webpackEmptyContext;\nwebpackEmptyContext.id = 767;\nmodule.exports = webpackEmptyContext;","module.exports = require(\"url\");","module.exports = require(\"vm\");","module.exports = require(\"worker_threads\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","// This is a convenient set of polyfills for running Zaplib in Node.js.\n// The idea is that you only need to import these polyfills to get Zaplib to run in Node.js.\n// Worker poylfil to use Webworkers\n// @ts-ignore\nimport Worker from \"./vendor/web-worker/node\";\nself.Worker = Worker;\n"],"names":["root","factory","exports","module","define","amd","global","URL","VM","threads","WORKER","Symbol","for","EVENTS","EventTarget","constructor","Object","defineProperty","this","value","Map","dispatchEvent","event","target","currentTarget","type","err","console","error","list","get","forEach","handler","call","addEventListener","fn","events","set","push","removeEventListener","index","indexOf","splice","Event","timeStamp","Date","now","data","isMainThread","Worker","url","options","super","name","mod","test","fileURLToPath","baseUrl","worker","__filename","workerData","on","postMessage","transferList","terminate","prototype","onmessage","onerror","onclose","mainThread","self","q","flush","buffered","parentPort","WorkerGlobalScope","close","process","exit","proto","getPrototypeOf","defineProperties","setPrototypeOf","bind","isDataUrl","catch","message","warn","evaluateDataUrl","then","Promise","resolve","workerThread","pathToFileURL","cwd","m","encoding","match","Error","decodeURIComponent","toLowerCase","Buffer","from","toString","parseDataUrl","runInThisContext","filename","webpackEmptyAsyncContext","req","e","code","keys","id","webpackEmptyContext","require","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","enumerable","obj","prop","hasOwnProperty","r","toStringTag"],"sourceRoot":""}