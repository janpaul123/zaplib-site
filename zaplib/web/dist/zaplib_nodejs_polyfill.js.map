{"version":3,"file":"zaplib_nodejs_polyfill.js","mappings":"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","sources":["webpack://zaplib/webpack/universalModuleDefinition","webpack://zaplib/./vendor/web-worker/node.js","webpack://zaplib/external node-commonjs \"url\"","webpack://zaplib/external node-commonjs \"vm\"","webpack://zaplib/external node-commonjs \"worker_threads\"","webpack://zaplib/webpack/bootstrap","webpack://zaplib/webpack/runtime/compat get default export","webpack://zaplib/webpack/runtime/define property getters","webpack://zaplib/webpack/runtime/hasOwnProperty shorthand","webpack://zaplib/webpack/runtime/make namespace object","webpack://zaplib/./zaplib_nodejs_polyfill.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"zaplib\"] = factory();\n\telse\n\t\troot[\"zaplib\"] = factory();\n})(global, function() {\nreturn ","/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nconst URL = require(\"url\");\n\nconst VM = require(\"vm\");\n\nconst threads = require(\"worker_threads\");\n\nconst WORKER = Symbol.for(\"worker\");\nconst EVENTS = Symbol.for(\"events\");\n\nclass EventTarget {\n  constructor() {\n    Object.defineProperty(this, EVENTS, {\n      value: new Map(),\n    });\n  }\n\n  dispatchEvent(event) {\n    event.target = event.currentTarget = this;\n\n    if (this[\"on\" + event.type]) {\n      try {\n        this[\"on\" + event.type](event);\n      } catch (err) {\n        console.error(err);\n      }\n    }\n\n    const list = this[EVENTS].get(event.type);\n    if (list == null) return;\n    list.forEach((handler) => {\n      try {\n        handler.call(this, event);\n      } catch (err) {\n        console.error(err);\n      }\n    });\n  }\n\n  addEventListener(type, fn) {\n    let events = this[EVENTS].get(type);\n    if (!events) this[EVENTS].set(type, (events = []));\n    events.push(fn);\n  }\n\n  removeEventListener(type, fn) {\n    let events = this[EVENTS].get(type);\n\n    if (events) {\n      const index = events.indexOf(fn);\n      if (index !== -1) events.splice(index, 1);\n    }\n  }\n}\n\nfunction Event(type, target) {\n  this.type = type;\n  this.timeStamp = Date.now();\n  this.target = this.currentTarget = this.data = null;\n} // this module is used self-referentially on both sides of the\n// thread boundary, but behaves differently in each context.\n\nmodule.exports = threads.isMainThread ? mainThread() : workerThread();\nconst baseUrl = URL.pathToFileURL(process.cwd() + \"/\");\n\nfunction mainThread() {\n  /**\n   * A web-compatible Worker implementation atop Node's worker_threads.\n   *  - uses DOM-style events (Event.data, Event.type, etc)\n   *  - supports event handler properties (worker.onmessage)\n   *  - Worker() constructor accepts a module URL\n   *  - accepts the {type:'module'} option\n   *  - emulates WorkerGlobalScope within the worker\n   * @param {string} url  The URL or module specifier to load\n   * @param {object} [options]  Worker construction options\n   * @param {string} [options.name]  Available as `self.name` within the Worker\n   * @param {string} [options.type=\"classic\"]  Pass \"module\" to create a Module Worker.\n   */\n  class Worker extends EventTarget {\n    constructor(url, options) {\n      // Webpack relies on Worker constructor to throw an error when passing undefined url\n      // This polyfill must match this behavior.\n      if (url === undefined) {\n        throw new Error(\"Creating worker with undefined url\");\n      }\n      super();\n      const { name, type } = options || {};\n      url += \"\";\n      let mod;\n\n      if (/^data:/.test(url)) {\n        mod = url;\n      } else {\n        mod = URL.fileURLToPath(new URL.URL(url, baseUrl));\n      }\n\n      const worker = new threads.Worker(__filename, {\n        workerData: {\n          mod,\n          name,\n          type,\n        },\n      });\n      Object.defineProperty(this, WORKER, {\n        value: worker,\n      });\n      worker.on(\"message\", (data) => {\n        const event = new Event(\"message\");\n        event.data = data;\n        this.dispatchEvent(event);\n      });\n      worker.on(\"error\", (error) => {\n        error.type = \"error\";\n        this.dispatchEvent(error);\n      });\n      worker.on(\"exit\", () => {\n        this.dispatchEvent(new Event(\"close\"));\n      });\n    }\n\n    postMessage(data, transferList) {\n      this[WORKER].postMessage(data, transferList);\n    }\n\n    terminate() {\n      this[WORKER].terminate();\n    }\n  }\n\n  Worker.prototype.onmessage =\n    Worker.prototype.onerror =\n    Worker.prototype.onclose =\n      null;\n  return Worker;\n}\n\nfunction workerThread() {\n  let { mod, name, type } = threads.workerData; // turn global into a mock WorkerGlobalScope\n\n  const self = (global.self = global); // enqueue messages to dispatch after modules are loaded\n\n  let q = [];\n\n  function flush() {\n    const buffered = q;\n    q = null;\n    buffered.forEach((event) => {\n      self.dispatchEvent(event);\n    });\n  }\n\n  threads.parentPort.on(\"message\", (data) => {\n    const event = new Event(\"message\");\n    event.data = data;\n    if (q == null) self.dispatchEvent(event);\n    else q.push(event);\n  });\n  threads.parentPort.on(\"error\", (err) => {\n    err.type = \"Error\";\n    self.dispatchEvent(err);\n  });\n\n  class WorkerGlobalScope extends EventTarget {\n    postMessage(data, transferList) {\n      threads.parentPort.postMessage(data, transferList);\n    } // Emulates https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope/close\n\n    close() {\n      process.exit();\n    }\n  }\n\n  let proto = Object.getPrototypeOf(global);\n  delete proto.constructor;\n  Object.defineProperties(WorkerGlobalScope.prototype, proto);\n  proto = Object.setPrototypeOf(global, new WorkerGlobalScope());\n  [\n    \"postMessage\",\n    \"addEventListener\",\n    \"removeEventListener\",\n    \"dispatchEvent\",\n  ].forEach((fn) => {\n    proto[fn] = proto[fn].bind(global);\n  });\n  global.name = name;\n  const isDataUrl = /^data:/.test(mod);\n\n  if (type === \"module\") {\n    // Using eval trick here to prevent webpack warnings:\n    // \"Critical dependency: the request of a dependency is an expression\"\n    eval('import')(mod)\n      .catch((err) => {\n        if (isDataUrl && err.message === \"Not supported\") {\n          console.warn(\n            \"Worker(): Importing data: URLs requires Node 12.10+. Falling back to classic worker.\"\n          );\n          return evaluateDataUrl(mod, name);\n        }\n\n        console.error(err);\n      })\n      .then(flush);\n  } else {\n    try {\n      if (/^data:/.test(mod)) {\n        evaluateDataUrl(mod, name);\n      } else {\n        // Using eval trick here to prevent webpack warnings:\n        // \"Critical dependency: the request of a dependency is an expression\"\n        eval('require')(mod);\n      }\n    } catch (err) {\n      console.error(err);\n    }\n\n    Promise.resolve().then(flush);\n  }\n}\n\nfunction evaluateDataUrl(url, name) {\n  const { data } = parseDataUrl(url);\n  return VM.runInThisContext(data, {\n    filename: \"worker.<\" + (name || \"data:\") + \">\",\n  });\n}\n\nfunction parseDataUrl(url) {\n  let [m, type, encoding, data] =\n    url.match(/^data: *([^;,]*)(?: *; *([^,]*))? *,(.*)$/) || [];\n  if (!m) throw Error(\"Invalid Data URL.\");\n  data = decodeURIComponent(data);\n  if (encoding)\n    switch (encoding.toLowerCase()) {\n      case \"base64\":\n        data = Buffer.from(data, \"base64\").toString();\n        break;\n\n      default:\n        throw Error('Unknown Data URL encoding \"' + encoding + '\"');\n    }\n  return {\n    type,\n    data,\n  };\n}\n","module.exports = require(\"url\");","module.exports = require(\"vm\");","module.exports = require(\"worker_threads\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","// This is a convenient set of polyfills for running Zaplib in Node.js.\n// The idea is that you only need to import these polyfills to get Zaplib to run in Node.js.\n// Worker poylfil to use Webworkers\n// @ts-ignore\nimport Worker from \"./vendor/web-worker/node\";\nself.Worker = Worker;\n"],"names":["root","factory","exports","module","define","amd","global","URL","VM","threads","WORKER","Symbol","for","EVENTS","EventTarget","constructor","Object","defineProperty","this","value","Map","dispatchEvent","event","target","currentTarget","type","err","console","error","list","get","forEach","handler","call","addEventListener","fn","events","set","push","removeEventListener","index","indexOf","splice","Event","timeStamp","Date","now","data","isMainThread","mainThread","workerThread","baseUrl","pathToFileURL","process","cwd","Worker","url","options","undefined","Error","super","name","mod","test","fileURLToPath","worker","__filename","workerData","on","postMessage","transferList","terminate","prototype","onmessage","onerror","onclose","self","q","flush","buffered","parentPort","WorkerGlobalScope","close","exit","proto","getPrototypeOf","defineProperties","setPrototypeOf","bind","isDataUrl","eval","catch","message","warn","evaluateDataUrl","then","Promise","resolve","parseDataUrl","runInThisContext","filename","m","encoding","match","decodeURIComponent","toLowerCase","Buffer","from","toString","require","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","enumerable","obj","prop","hasOwnProperty","r","toStringTag"],"sourceRoot":""}